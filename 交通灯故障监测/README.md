# 交通灯故障检测系统V2.0


https://user-images.githubusercontent.com/62071831/217464253-ac0490ae-b449-41e9-a09b-e3ff7595cda3.mp4


## 交通路口说明

![交通路口](https://i.loli.net/2021/04/26/oHIz8VsFCJTnxL7.png)

> 说明：将T字型路口的红绿灯分为左路灯，右路灯以及转向灯，左右路灯上分布红黄绿灯，转向灯上只装红绿灯，这样总共就8盏灯，方便后续电路设计。



交通规则如下：

- 左路口红灯亮，右路口绿灯亮，转向灯红灯亮

  > 右车道通行，左边车可行驶到右边，同时人行道SW1，SW3，SW5通行

- 左路口绿灯亮，右路口红灯亮，转向灯红灯亮

  > 左车道通行，右边车可行驶到左边，也可向下行驶，同时人行道SW2，SW4通行

- 左路口绿灯亮，右路口红灯亮，转向灯绿灯亮

  > 左车道通行，下边车可行驶到左边，也可调头行驶

- 左，右路口的黄灯亮，转向灯红灯亮

  > 此时处于黄灯等待状态，所有车道均不通行

> **注：向右行驶的车辆，如左边车道的车向下行驶，下边车道的车向右行驶，可直接通过弯道通行，不受红绿灯限制**

## 逻辑表达式

按以上规则我们可知道正确的亮灯顺序，现根据此写出如下逻辑式

> Y = (RL·YL\`·GL\`·RR\`·YR\`·GR·RC·GC\`+RL\`·YL\`·GL·RR·YR\`·GR\`·RC·GC\`
> RL\`·YL\`·GL·RR·YR\`·GR\`·RC\`·GC+RL\`·YL·GL\`·RR\`·YR·GR\`·RC·GC\` ) \`

**符号说明：第一个字母代表灯的颜色，第二个字母代表灯的方位，如RL（R:Red, L:Left）**

逻辑式比较简单，关于真值表，逻辑图那些我就不画了哈（难写）

> Y=(RL·YL\`·GL\`·RR\`·YR\`·GR ·RC·GC\`)\`·(RL\`·YL\`·GL·RR·YR\`·GR\`·RC·GC\)\`
>·(RL\`·YL\`·GL·RR·YR\`·GR\`·RC\`·GC)\` · (RL\`·YL·GL\`·RR\`·YR·GR\`·RC·GC\`)\`

*为了在同一家店铺买到所需的门芯片，我们还需要做一些变换，这样我们就只需要一个八非门(74HC240)，四个八输入与非门(74HC30)和一个二输入四与门(74HC08)或一个四输入二与门(自行百度哈，关于门芯片的资料太少了)*

## 电路设计

  由于之前我与51的恩短情愁，现改用esp32开发版作为主控芯片，PCF8574作为8盏LED的驱动芯片，各门芯片组成交通灯故障监测系统，具体电路图在`./Pcb_/V2.0`下，

电路比较简单，但难就难在PCB布线时，为在背面腾出空地画交通路口，不得不将所有的芯片都放在顶层，一味的追求工整，所换来的就是无数的交叉白线，布线的时候差点把我整吐了，索性本着玩连连看的心态，终于是连完了。

![image-20210427170216570](https://i.loli.net/2021/04/27/uMwhs8xaokEnpHc.png)

关于电路设计的一些问题：

- 为何不用ESP32模块，而用ESP32开发板：ESP32模块是一次性的，而且集成在这么一块小板子上属实浪费
- ESP32开发板上已经有了电源，为何要外接电源：ESP32开发板上确实有3.3V电源，但输出电流最大只有300mA，可能会不足以支撑整个板子（具体没算，也可能是我想多了）
- 为何要用PCF8574作为LED的驱动芯片：之前想过直接用开发板的8个IO口驱动得了，但整个门芯片电路VCC为5V，且采用的是CMOS电平，高电平定义为Vh=0.7VCC=3.5V, 这也就意味着ESP32引脚上的3.3V在门电路这里只能勾到颈部位置。再者，PCF8574采用的是I2C传输，仅需2个IO口就可控制8个3态IO口，且PCF8574采用的是CMOS电平，综上，我没理由不选它啊
- 为何要用CMOS电路而不用TTL：CMOS电路的驱动性强，不需要接上拉电阻即可驱动LED

## 软件设计

开发环境: `VScode+PlatformIO` 搭建教程 [博客](https://blog.csdn.net/qq_45516773/article/details/115406420)

所用到的第三方库：
|库名		|说明|
|---------|----|
|ESP8266 and ESP32 OLED driver for SSD1306 displays@^4.2.0|OLED驱动库|
|Time@^1.6|时间库|
|PCF8574@^0.2.1|PCF8574驱动库|
|Blynk@^0.6.7|Blynk物联网平台([helloworld教程【待定】]|

## 故障模拟说明

| |故障形式1|故障形式2|
|--|:-----:|:-------:|
|反馈|实时  |非实时   |
|说明|故障1为乱码显示，即8盏灯随机亮几盏，在这种形式下，错误反馈是实时的|故障2为模拟随机一盏灯损坏的情况，在某些情况下，该灯不亮也视为正常情况，则反馈并不是实时的，只有当扫描机制扫描到此灯不亮为非正常情况才会发出错误信号|


## 成果展示（PNG）
| 硬件端| 手机端 | PC端 |
| :----- | :----- | :--- |
| ![image-20210511194542938](https://i.loli.net/2021/05/11/3aHePrhMLDgVQlv.png) | ![image-20210511194944350](https://i.loli.net/2021/05/11/48nElBId5qfbzYo.png) |![image-20210511195217196](https://i.loli.net/2021/05/11/W2vmN4okhgHwS3U.png)|






> 说明：主文件在`./code_/platformIO/src/main.cpp`中，第一次使用需要对配置信息修改
>
> 感谢大佬们对于开源第三方库的无私贡献，让我体验了一把，站在巨人的肩膀上，一览众山小。



## 版本日志

- 修复了V1.0中PCF8574T模块驱动不足的问题
- 修复了V1.0中开发版电源会直通电路的问题
- 修复了v1.0中板载不同LED发亮程度不一样的问题
- PCB布线采用了圆滑线条，使电路板更加性感
- 加入了Blynk物联网平台，现可通过手机了解并控制到整个交通网络的信息
